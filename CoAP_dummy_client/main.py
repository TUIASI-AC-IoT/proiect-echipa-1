import socket
import sys
import select
import threading

#py main.py --r_port=65416 --s_port=65415 --s_ip=192.168.0.103
from bitarray import bitarray


def receive_fct():
    global running
    counter = 0
    while running:
        # Apelam la functia sistem IO -select- pentru a verifca daca socket-ul are date in bufferul de receptie
        # Stabilim un timeout de 1 secunda
        r, _, _ = select.select([s], [], [], 1)
        if not r:
            counter = counter + 1
        else:
            data, address = s.recvfrom(65507)
            print("RECEIVED ===> ", data, " <=== FROM: ", address)
            print("cnt=", counter)


# Citire nr port din linia de comanda
if len(sys.argv) != 4:
    print("help : ")
    print("  --r_port=receive port ")
    print("  --s_port=send port ")
    print("  --s_ip=sen ip")
    sys.exit()

for arg in sys.argv:
    if arg.startswith("--r_port"):
        temp, r_port = arg.split("=")
    elif arg.startswith("--s_port"):
        temp, s_port = arg.split("=")
    elif arg.startswith("--s_ip"):
        temp, s_ip = arg.split("=")

# Creare socket UDP
s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM, socket.IPPROTO_UDP)

s.bind(('0.0.0.0', int(r_port)))

running = True

try:
    receive_thread = threading.Thread(target=receive_fct)
    receive_thread.start()
except:
    print("Eroare la pornirea thread‐ului")
    sys.exit()

while True:
    try:
        useless = input("Send: ")
        test_data = bitarray('00 11 0001 111 00000 1111111111111111 11111111    1110 1101 00000001 01010011 00100111 01000001 01000011 01000101 01010011 01010100 01000001 00100000 01000101 01010011 01010100 01000101 00100000 01010101 01001110 00100000 01010100 01000101 01011000 01010100 00100000 01000100 01000101 00100000 01010000 01010010 01001111  1101 1110 00111000 0000001000000001 01100100 01110010 01100001 01100111 01100001 00100000 01101010 01110101 01110010 01101110 01100001 01101100 00100000 01100001 01110011 01110100 01100001 01111010 01101001 00100000 01100101 01110101 00100000 01101101 00101101 01100001 01101101 00100000 01100001 01110000 01110101 01100011 01100001 01110100 00100000 01100100 01100101 00100000 01100011 01101111 01100100 01100001 01110100 00100000 01101100 01100001 00100000 01110000 01110010 01101111 01101001 01100101 01100011 01110100 00100000 01110110 01110010 01100101 01100001 01110101 00100000 01110011 01100001 00100000 01110011 01110000 01110101 01101110 00100000 01100011 01100001 00100000 01101001 01101101 01101001 00100000 01110110 01101001 01101110 01100101 00100000 01110011 01100001 00100000 01101001 01101101 01101001 00100000 01100010 01100001 01100111 00100000 01110000 01110101 01101100 01100001 00100000 01101001 01101110 00100000 01100101 01101100 00100000 01100011 01100001 00100000 01101101 01101001 00100000 01110011 01100101 00100000 01110000 01100001 01110010 01100101 00100000 01100110 01101111 01100001 01110010 01110100 01100101 00100000 01100110 01101111 01100001 01110010 01110100 01100101 00100000 01101111 01100010 01101111 01110011 01101001 01110100 01101111 01110010 00100000 01110011 01101001 00100000 01100001 01100011 01110101 01101101 00100000 01100101 01110101 00100000 01110011 01100011 01110010 01101001 01110101 00100000 01110101 01101110 00100000 01110100 01100101 01111000 01110100 00100000 01100100 01100101 00100000 01110100 01100101 01110011 01110100 00100000 01100100 01100101 00100000 01101100 01110101 01101110 01100111 01101001 01101101 01100101 00100000 00110010 00110100 00110100 00100000 00110001 00110101 00100000 01110011 01101001 00100000 01100011 01110101 00100000 00110001 00110101 00100000 01110011 01101001 00100000 00110001 00110101 00101110 00100000 01110000 01110101 01101100 01100001 00100000 01101101 01100101 01100001 00100000 01100101 01110011 01110100 01100101 00100000 01100110 01101111 01100001 01110010 01110100 01100101 00100000 01100110 01101111 01100001 01110010 01110100 01100101 00100000 01101101 01100001 01110010 01100101 00100000 01101101 01100001 01110010 011001011111 1111 000 1111111111111111 01110100 01100101 01111000 01110100 00100000 01100100 01100101 00100000 01110100 01100101 01110011 01110100')
        s.sendto(test_data.tobytes(), (s_ip, int(s_port)))
    except KeyboardInterrupt:
        running = False
        print("Waiting for the thread to close...")
        receive_thread.join()
        break
